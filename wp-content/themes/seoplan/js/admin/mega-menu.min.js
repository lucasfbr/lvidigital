var smm=smm||{};!function(a,b){"use strict";var c=window.wp;smm={init:function(){this.$body=a("body"),this.$modal=a("#smm-settings"),this.itemData={},this.templates={},this.frame=c.media({library:{type:"image"}}),this.initTemplates(),this.initActions()},initTemplates:function(){b.each(smmModals,function(a){smm.templates[a]=c.template("seoplan-"+a)})},initActions:function(){smm.$body.on("click",".opensettings",this.openModal).on("click",".smm-modal-backdrop, .smm-modal-close, .smm-button-cancel",this.closeModal),smm.$modal.on("click",".smm-menu a",this.switchPanel).on("click",".smm-column-handle",this.resizeMegaColumn).on("click",".smm-button-save",this.saveChanges)},openModal:function(){return smm.getItemData(this),smm.$modal.show(),smm.$body.addClass("modal-open"),smm.render(),!1},closeModal:function(){return smm.$modal.hide().find(".smm-content").html(""),smm.$body.removeClass("modal-open"),!1},switchPanel:function(b){b.preventDefault();var c=a(this),d=c.data("panel");c.addClass("active").siblings(".active").removeClass("active"),smm.openSettings(d)},render:function(){smm.$modal.find(".smm-frame-menu .smm-menu").html(smm.templates.menus(smm.itemData));var a=smm.$modal.find(".smm-menu a.active");this.openSettings(a.data("panel"))},openSettings:function(a){var b=smm.$modal.find(".smm-frame-content .smm-content"),c=b.children("#smm-panel-"+a);c.length?c.addClass("active").siblings().removeClass("active"):(b.append(smm.templates[a](smm.itemData)),b.children("#smm-panel-"+a).addClass("active").siblings().removeClass("active"),"mega"==a&&smm.initMegaColumns(),"background"==a&&smm.initBackgroundFields(),"icon"==a&&smm.initIconFields());var d=smm.$modal.find(".smm-frame-menu .smm-menu a[data-panel="+a+"]").data("title");smm.$modal.find(".smm-frame-title").html(smm.templates.title({title:d}))},resizeMegaColumn:function(b){b.preventDefault();var c,d=a(b.currentTarget),e=d.closest(".smm-submenu-column"),f=e.data("width"),g=smm.getWidthData(f);g&&(c=d.hasClass("smm-resizable-w")?g.increase?g.increase:g:g.decrease?g.decrease:g,e[0].style.width=c.width,e.data("width",c.width),e.find(".smm-column-width-label").text(c.label),e.find(".menu-item-depth-0 .menu-item-width").val(c.width))},getWidthData:function(a){var c=[{width:"25.00%",label:"1/4"},{width:"33.33%",label:"1/3"},{width:"50.00%",label:"1/2"},{width:"66.66%",label:"2/3"},{width:"75.00%",label:"3/4"},{width:"100.00%",label:"1/1"}],d=b.findIndex(c,function(b){return b.width==a});if("undefined"===d)return!1;var e={index:d,width:c[d].width,label:c[d].label};return d>0&&(e.decrease={index:d-1,width:c[d-1].width,label:c[d-1].label}),d<c.length-1&&(e.increase={index:d+1,width:c[d+1].width,label:c[d+1].label}),e},initMegaColumns:function(){var c=smm.$modal.find("#smm-panel-mega .smm-submenu-column"),d="25.00%";c.length&&(c.length<4&&(d=String((100/c.length).toFixed(2))+"%"),b.each(c,function(b){var c=(a(b),b.dataset.width);c=c||d;var e=smm.getWidthData(c);b.style.width=e.width,b.dataset.width=e.width,a(b).find(".menu-item-depth-0 .menu-item-width").val(c),a(b).find(".smm-column-width-label").text(e.label)}))},initBackgroundFields:function(){smm.$modal.find(".background-color-picker").wpColorPicker(),smm.$modal.on("click",".background-image .upload-button",function(b){b.preventDefault();var c=a(this);smm.frame.off("select"),smm.frame.on("select",function(){var a=smm.frame.state().get("selection").first().toJSON().url;c.siblings(".background-image-preview").html('<img src="'+a+'">'),c.siblings("input").val(a),c.siblings(".remove-button").removeClass("hidden")}),smm.frame.open()}).on("click",".background-image .remove-button",function(b){b.preventDefault();var c=a(this);c.siblings(".background-image-preview").html(""),c.siblings("input").val(""),c.addClass("hidden")}),smm.$modal.on("change",".background-position select",function(){var b=a(this);"custom"==b.val()?b.next("input").removeClass("hidden"):b.next("input").addClass("hidden")})},initIconFields:function(){var b=smm.$modal.find("#smm-icon-input"),c=smm.$modal.find("#smm-selected-icon"),d=smm.$modal.find(".smm-icon-selector .icons i");smm.$modal.on("click",".smm-icon-selector .icons i",function(){var d=a(this),e=d.data("icon");d.addClass("active").siblings(".active").removeClass("active"),b.val(e),c.html('<i class="'+e+'"></i>')}),c.on("click","i",function(){a(this).remove(),b.val("")}),smm.$modal.on("keyup",".smm-icon-search",function(){var b=a(this).val().toUpperCase();b?d.hide().filter(function(){return a(this).data("icon").toUpperCase().indexOf(b)>-1}).show():d.show()})},getItemData:function(c){var d=a(c).closest("li.menu-item"),e=d.find(".mega-data"),f=d.childMenuItems(),g=e.data("mega");g.content=e.html(),smm.itemData={depth:d.menuItemDepth(),megaData:g,data:d.getItemData(),children:[],element:d.get(0)},b.isEmpty(f)||b.each(f,function(b){var c=a(b),d=c.find(".mega-data"),e=c.menuItemDepth(),f=d.data("mega");f.content=d.html(),smm.itemData.children.push({depth:e,subDepth:e-smm.itemData.depth-1,data:c.getItemData(),megaData:f,element:b})}),console.log(smm.itemData)},setItemData:function(c,d){var e=a(c).find(".mega-data");b.has(d,"content")&&(e.html(d.content),delete d.content),e.data("mega",d)},getFieldName:function(a,b){return a=a.split("."),a="["+a.join("][")+"]","menu-item-mega["+b+"]"+a},saveChanges:function(){var c=smm.$modal.find(".smm-content :input").serialize(),d=smm.$modal.find(".smm-toolbar .spinner");d.addClass("is-active"),a.post(ajaxurl,{action:"seoplan_save_menu_item_data",data:c},function(a){if(a.success){var c=a.data["menu-item-mega"];b.has(c,smm.itemData.data["menu-item-db-id"])&&smm.setItemData(smm.itemData.element,c[smm.itemData.data["menu-item-db-id"]]),b.each(smm.itemData.children,function(a){b.has(c,a.data["menu-item-db-id"])&&smm.setItemData(a.element,c[a.data["menu-item-db-id"]])}),d.removeClass("is-active"),smm.closeModal()}})}},a(function(){smm.init()})}(jQuery,_);